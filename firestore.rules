rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper Functions ──────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isBusinessOwner(businessId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/businesses/$(businessId)).data.ownerId == request.auth.uid;
    }

    function belongsToBusiness(businessId) {
      return isAuthenticated() &&
        businessId in getUserData().businessIds;
    }

    function isBusinessMember(businessId) {
      return isBusinessOwner(businessId) || belongsToBusiness(businessId);
    }

    // ─── Users Collection ──────────────────────────────────────
    // Users can only read/write their own document
    match /users/{userId} {
      allow read: if isUser(userId);
      allow create: if isUser(userId);
      allow update: if isUser(userId);
      allow delete: if false;
    }

    // Owner can list users that belong to their business
    match /users/{userId} {
      allow read: if isAuthenticated() && 
        getUserData().role == 'owner' &&
        resource.data.businessIds.hasAny(getUserData().businessIds);
    }

    // ─── Businesses Collection ─────────────────────────────────
    // Public read (needed for SEO websites and slug resolution)
    // Only owner can write
    match /businesses/{businessId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isBusinessOwner(businessId);
      allow delete: if false;

      // ─── Bookings Subcollection (legacy) ─────────────────
      // Require basic data validation for creates
      // Business members can read/update
      match /bookings/{bookingId} {
        allow create: if request.resource.data.keys().hasAll(['name', 'phone']) &&
          request.resource.data.name is string &&
          request.resource.data.phone is string;
        allow read: if isBusinessMember(businessId);
        allow update: if isBusinessMember(businessId);
        allow delete: if isBusinessOwner(businessId);
      }

      // ─── Menu Items Subcollection ─────────────────────────
      // Public read (customers need to see the menu)
      // Only owner/manager can write
      match /menuItems/{itemId} {
        allow read: if true;
        allow create: if isBusinessOwner(businessId);
        allow update: if isBusinessMember(businessId);
        allow delete: if isBusinessOwner(businessId);
      }

      // ─── Orders Subcollection ─────────────────────────────
      // Require order data validation for creates
      // Business members can read/update (manage orders)
      // Customers can read their own orders
      match /orders/{orderId} {
        allow create: if request.resource.data.keys().hasAll(['items', 'total', 'orderType']) &&
          request.resource.data.total is number &&
          request.resource.data.total > 0;
        allow read: if isBusinessMember(businessId) ||
          (isAuthenticated() && resource.data.customerId == request.auth.uid);
        allow update: if isBusinessMember(businessId);
        allow delete: if false;
      }

      // ─── Driver Locations Subcollection ────────────────────
      // Only the driver themselves can write their GPS
      match /driverLocations/{driverId} {
        allow read: if isBusinessMember(businessId);
        allow write: if isUser(driverId) && belongsToBusiness(businessId);
      }

      // ─── Jukebox Queue Subcollection ───────────────────────
      // Public read (customers see the queue)
      // Authenticated users can add songs, business members manage
      match /jukeboxQueue/{songId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update: if isBusinessMember(businessId);
        allow delete: if isBusinessOwner(businessId);
      }

      // ─── Staff On Duty Subcollection ───────────────────────
      // Business members can read/write staff duty status
      match /staffOnDuty/{staffId} {
        allow read: if isBusinessMember(businessId);
        allow create: if isBusinessOwner(businessId);
        allow update: if isBusinessMember(businessId);
        allow delete: if isBusinessOwner(businessId);
      }

      // ─── KDS Stations Subcollection ────────────────────────
      // Business members can read/write kitchen display stations
      match /kdsStations/{stationId} {
        allow read: if isBusinessMember(businessId);
        allow create: if isBusinessOwner(businessId);
        allow update: if isBusinessMember(businessId);
        allow delete: if isBusinessOwner(businessId);
      }

      // ─── Invite Codes Subcollection ────────────────────────
      // Public read (for driver/staff signup), owner write
      match /inviteCodes/{codeId} {
        allow read: if true;
        allow write: if isBusinessOwner(businessId);
      }
    }

    // ─── Platform Collection ───────────────────────────────────
    // Public read, admin SDK write only
    match /platform/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // ─── Couriers Collection ──────────────────────────────────
    // Couriers can read/write their own document
    // Admins can update courier documents (approve/reject applications)
    // Business owners can read couriers
    match /couriers/{courierId} {
      allow read: if isAuthenticated();
      allow create: if isUser(courierId);
      allow update: if isUser(courierId) || getUserData().role == 'admin';
      allow delete: if false;
    }

    // ─── Tracking Links Collection ────────────────────────────
    // Public read (customer tracking pages), authenticated create
    match /trackingLinks/{linkId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }

    // ─── Quick Deliveries Collection ──────────────────────────
    // Anyone can create a quick delivery request
    // Authenticated users can read their own or assigned deliveries
    // Couriers can update (accept/complete) and admins can manage
    match /quickDeliveries/{deliveryId} {
      allow create: if true;
      allow read: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.assignedCourierId == request.auth.uid ||
        getUserData().role == 'admin' ||
        getUserData().role == 'driver_marketplace'
      );
      allow delete: if false;
    }

    // ─── Custom Domains Collection ────────────────────────────
    // Public read (for domain resolution), admin SDK write only
    match /customDomains/{domainId} {
      allow read: if true;
      allow write: if false;
    }
  }
}