/*
 * Firebase Realtime Database Rules
 * For Real-Time Driver Tracking
 * 
 * Security Strategy:
 * - Drivers can only update their own location
 * - Customers can read driver location for active orders
 * - Restaurants can read all driver locations
 * - No one else has access
 */

{
  "rules": {
    "restaurants": {
      "$restaurantId": {
        "drivers": {
          "$driverId": {
            "location": {
              ".write": "auth.uid === $driverId",
              ".read": "auth !== null"
            },
            "status": {
              ".write": "auth.uid === $driverId",
              ".read": "auth !== null"
            },
            "currentOrderId": {
              ".write": "root.child('restaurants').child($restaurantId).child('managers').hasChild(auth.uid) || auth.uid === $driverId",
              ".read": "auth !== null"
            },
            ".read": "auth !== null",
            ".validate": "newData.hasChildren(['location', 'status'])"
          },
          ".indexOn": ["status", "currentOrderId"]
        },
        
        "orders": {
          "$orderId": {
            ".read": "auth !== null",
            ".write": "root.child('restaurants').child($restaurantId).child('managers').hasChild(auth.uid)"
          }
        },
        
        "managers": {
          "$uid": {
            ".read": "auth.uid === $uid",
            ".write": "root.child('restaurants').child($restaurantId).child('managers').hasChild(auth.uid)"
          }
        }
      }
    },
    
    "couriers": {
      "$courierId": {
        "location": {
          ".write": "auth.uid === $courierId",
          ".read": "auth !== null"
        },
        "status": {
          ".write": "auth.uid === $courierId",
          ".read": "auth !== null"
        },
        "currentOrderId": {
          ".write": "auth.uid === $courierId",
          ".read": "auth !== null"
        },
        ".read": "auth !== null"
      },
      ".indexOn": ["status"]
    }
  }
}
